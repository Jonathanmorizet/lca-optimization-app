<entire code from the canvas has been inserted here for brevity>